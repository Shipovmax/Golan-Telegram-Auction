# -*- coding: utf-8 -*-
"""
–ü—Ä–æ—Å—Ç–æ–π —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∞—É–∫—Ü–∏–æ–Ω–∞
–ë–ï–ó –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π - —Ç–æ–ª—å–∫–æ Flask
"""

import os
import sys

# –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–æ–≤
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

try:
    from flask import Flask, render_template, request, jsonify
    import random
    from datetime import datetime
    from typing import List, Dict, Optional, Tuple
    from dataclasses import dataclass
except ImportError as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
    print("üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Flask: pip install Flask")
    sys.exit(1)

# –°–æ–∑–¥–∞–µ–º Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
app = Flask(__name__)
app.secret_key = 'golan-auction-secret-key'

# –ü—Ä–æ—Å—Ç—ã–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ dataclass –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
class Player:
    def __init__(self, id, name, balance, wants, no_wants):
        self.id = id
        self.name = name
        self.balance = balance
        self.initial_balance = balance
        self.wants = wants
        self.no_wants = no_wants
        self.total_profit = 0
        self.purchases = 0
        self.sales = 0
        self.is_user = False
        self.session_id = None
    
    def to_dict(self):
        return {
            'id': self.id,
            'name': self.name,
            'balance': self.balance,
            'initial_balance': self.initial_balance,
            'wants': self.wants,
            'no_wants': self.no_wants,
            'total_profit': self.total_profit,
            'purchases': self.purchases,
            'sales': self.sales
        }
    
    def can_buy(self, price):
        return self.balance >= price
    
    def get_preference_multiplier(self, product_name):
        if product_name == self.wants:
            return 1.5
        elif product_name == self.no_wants:
            return 0.3
        else:
            return 1.0
    
    def buy_product(self, product, price):
        if not self.can_buy(price):
            return 0
        
        self.balance -= price
        self.purchases += 1
        profit = product.cost - price
        self.total_profit += profit
        self.sales += 1
        return profit

class Product:
    def __init__(self, id, name, cost, price, quantity):
        self.id = id
        self.name = name
        self.cost = cost
        self.initial_price = price
        self.current_price = price
        self.quantity = quantity
        self.initial_quantity = quantity
    
    def to_dict(self):
        return {
            'id': self.id,
            'name': self.name,
            'cost': self.cost,
            'initial_price': self.initial_price,
            'current_price': self.current_price,
            'quantity': self.quantity,
            'initial_quantity': self.initial_quantity
        }
    
    def is_available(self):
        return self.quantity > 0
    
    def reduce_price(self, ratio=0.95):
        self.current_price = int(self.current_price * ratio)
    
    def sell_one(self):
        if self.is_available():
            self.quantity -= 1
            return True
        return False
    
    def reset_to_initial(self):
        self.current_price = self.initial_price
        self.quantity = self.initial_quantity

class Game:
    def __init__(self):
        self.id = 1
        self.status = 'waiting'
        self.current_round = 0
        self.current_product_id = None
        self.winner_id = None
        self.start_time = datetime.utcnow()
        self.end_time = None
    
    def to_dict(self):
        return {
            'id': self.id,
            'status': self.status,
            'current_round': self.current_round,
            'current_product_id': self.current_product_id,
            'winner_id': self.winner_id,
            'start_time': self.start_time.isoformat() if self.start_time else None,
            'end_time': self.end_time.isoformat() if self.end_time else None
        }

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–π –≤–µ—Ä—Å–∏–∏
players = []
products = []
current_game = None
user_session_id = None

def create_initial_data():
    """–°–æ–∑–¥–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"""
    global players, products
    
    # –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤
    all_products = [
        "–†–æ–∑—ã", "–ü–∏–æ–Ω—ã", "–ì–µ–æ—Ä–≥–∏–Ω—ã", "–†–æ–º–∞—à–∫–∏", "–õ–∏–ª–∏–∏", "–¢—é–ª—å–ø–∞–Ω—ã",
        "–û—Ä—Ö–∏–¥–µ–∏", "–•—Ä–∏–∑–∞–Ω—Ç–µ–º—ã", "–õ–∞–≤–∞–Ω–¥–∞", "–ù–∞—Ä—Ü–∏—Å—Å—ã", "–ò—Ä–∏—Å—ã", "–ì–≤–æ–∑–¥–∏–∫–∏"
    ]
    
    # –°–ø–∏—Å–æ–∫ –∏–º–µ–Ω –∏–≥—Ä–æ–∫–æ–≤
    player_names = ["–í–∞–Ω—è", "–ê–Ω–∞—Å—Ç–∞—Å–∏—è", "–ò–≥–æ—Ä—å", "–ú–∞—Ä–∏–Ω–∞", "–î–º–∏—Ç—Ä–∏–π", "–°–≤–µ—Ç–ª–∞–Ω–∞"]
    
    # –°–æ–∑–¥–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤
    players = []
    for i, name in enumerate(player_names):
        wants = random.choice(all_products)
        no_wants = random.choice([p for p in all_products if p != wants])
        balance = random.randint(150000, 195000)
        
        player = Player(i + 1, name, balance, wants, no_wants)
        players.append(player)
    
    # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_wants = random.choice(all_products)
    user_no_wants = random.choice([p for p in all_products if p != user_wants])
    user_balance = random.randint(150000, 195000)
    
    user_player = Player(len(players) + 1, "–í—ã (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)", user_balance, user_wants, user_no_wants)
    user_player.is_user = True
    players.append(user_player)
    
    # –°–æ–∑–¥–∞–µ–º —Ç–æ–≤–∞—Ä—ã
    products_data = [
        {"name": "–†–æ–∑—ã", "cost": 50000, "price": 80000, "quantity": 300},
        {"name": "–ü–∏–æ–Ω—ã", "cost": 85000, "price": 150000, "quantity": 100},
        {"name": "–ì–µ–æ—Ä–≥–∏–Ω—ã", "cost": 30000, "price": 50000, "quantity": 80},
        {"name": "–†–æ–º–∞—à–∫–∏", "cost": 100000, "price": 130000, "quantity": 500},
        {"name": "–õ–∏–ª–∏–∏", "cost": 60000, "price": 95000, "quantity": 200},
        {"name": "–¢—é–ª—å–ø–∞–Ω—ã", "cost": 40000, "price": 65000, "quantity": 350},
        {"name": "–û—Ä—Ö–∏–¥–µ–∏", "cost": 120000, "price": 200000, "quantity": 60},
        {"name": "–•—Ä–∏–∑–∞–Ω—Ç–µ–º—ã", "cost": 45000, "price": 70000, "quantity": 250},
        {"name": "–õ–∞–≤–∞–Ω–¥–∞", "cost": 20000, "price": 35000, "quantity": 400},
        {"name": "–ù–∞—Ä—Ü–∏—Å—Å—ã", "cost": 55000, "price": 90000, "quantity": 150},
        {"name": "–ò—Ä–∏—Å—ã", "cost": 70000, "price": 115000, "quantity": 120},
        {"name": "–ì–≤–æ–∑–¥–∏–∫–∏", "cost": 25000, "price": 45000, "quantity": 300}
    ]
    
    products = []
    for i, product_data in enumerate(products_data):
        product = Product(
            i + 1,
            product_data["name"],
            product_data["cost"],
            product_data["price"],
            product_data["quantity"]
        )
        products.append(product)

def reset_all_players():
    """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤"""
    global players
    for player in players:
        player.balance = player.initial_balance
        player.total_profit = 0
        player.purchases = 0
        player.sales = 0

def reset_all_products():
    """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã"""
    global products
    for product in products:
        product.reset_to_initial()

def randomize_all_players():
    """–†–∞–Ω–¥–æ–º–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤"""
    global players
    all_products = [
        "–†–æ–∑—ã", "–ü–∏–æ–Ω—ã", "–ì–µ–æ—Ä–≥–∏–Ω—ã", "–†–æ–º–∞—à–∫–∏", "–õ–∏–ª–∏–∏", "–¢—é–ª—å–ø–∞–Ω—ã",
        "–û—Ä—Ö–∏–¥–µ–∏", "–•—Ä–∏–∑–∞–Ω—Ç–µ–º—ã", "–õ–∞–≤–∞–Ω–¥–∞", "–ù–∞—Ä—Ü–∏—Å—Å—ã", "–ò—Ä–∏—Å—ã", "–ì–≤–æ–∑–¥–∏–∫–∏"
    ]
    
    for player in players:
        if not player.is_user:  # –†–∞–Ω–¥–æ–º–∏–∑–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ AI –∏–≥—Ä–æ–∫–æ–≤
            player.wants = random.choice(all_products)
            player.no_wants = random.choice([p for p in all_products if p != player.wants])
            player.initial_balance = random.randint(150000, 195000)
            player.balance = player.initial_balance
            player.total_profit = 0
            player.purchases = 0
            player.sales = 0

def create_new_user_session(session_id):
    """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    global players, user_session_id
    user_session_id = session_id
    
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    players = [p for p in players if not p.is_user]
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    all_products = [
        "–†–æ–∑—ã", "–ü–∏–æ–Ω—ã", "–ì–µ–æ—Ä–≥–∏–Ω—ã", "–†–æ–º–∞—à–∫–∏", "–õ–∏–ª–∏–∏", "–¢—é–ª—å–ø–∞–Ω—ã",
        "–û—Ä—Ö–∏–¥–µ–∏", "–•—Ä–∏–∑–∞–Ω—Ç–µ–º—ã", "–õ–∞–≤–∞–Ω–¥–∞", "–ù–∞—Ä—Ü–∏—Å—Å—ã", "–ò—Ä–∏—Å—ã", "–ì–≤–æ–∑–¥–∏–∫–∏"
    ]
    
    user_wants = random.choice(all_products)
    user_no_wants = random.choice([p for p in all_products if p != user_wants])
    user_balance = random.randint(150000, 195000)
    
    user_player = Player(len(players) + 1, "–í—ã (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)", user_balance, user_wants, user_no_wants)
    user_player.is_user = True
    user_player.session_id = session_id
    players.append(user_player)
    
    return user_player

def get_user_player(session_id):
    """–ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ session_id"""
    for player in players:
        if player.is_user and player.session_id == session_id:
            return player
    return None

class SimpleDutchAuctionEngine:
    """–ü—Ä–æ—Å—Ç–æ–π –¥–≤–∏–∂–æ–∫ –≥–æ–ª–ª–∞–Ω–¥—Å–∫–æ–≥–æ –∞—É–∫—Ü–∏–æ–Ω–∞"""
    
    def __init__(self):
        self.price_reduction_step = 0.05
        self.min_price_ratio = 0.3
    
    def start_new_game(self, session_id=None):
        """–ù–∞—á–∏–Ω–∞–µ—Ç –Ω–æ–≤—É—é –∏–≥—Ä—É"""
        global current_game, players, products
        
        try:
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É
            current_game = Game()
            current_game.status = 'playing'
            current_game.current_round = 1
            
            # –†–∞–Ω–¥–æ–º–∏–∑–∏—Ä—É–µ–º –∏–≥—Ä–æ–∫–æ–≤
            randomize_all_players()
            
            # –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if session_id:
                create_new_user_session(session_id)
            
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã
            reset_all_products()
            
            return True
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –Ω–æ–≤–æ–π –∏–≥—Ä—ã: {e}")
            return False
    
    def get_current_game_state(self):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã"""
        global current_game, players, products
        
        if not current_game:
            return {
                'game': None,
                'players': [],
                'products': [],
                'message': '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∏–≥—Ä—ã'
            }
        
        return {
            'game': current_game.to_dict(),
            'players': [p.to_dict() for p in players],
            'products': [p.to_dict() for p in products]
        }
    
    def conduct_dutch_auction_round(self):
        """–ü—Ä–æ–≤–æ–¥–∏—Ç —Ä–∞—É–Ω–¥ –≥–æ–ª–ª–∞–Ω–¥—Å–∫–æ–≥–æ –∞—É–∫—Ü–∏–æ–Ω–∞"""
        global current_game, players, products
        
        try:
            if not current_game or current_game.status != 'playing':
                return {
                    'success': False,
                    'message': '–ò–≥—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é –∏–≥—Ä—É.'
                }
            
            # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ç–æ–≤–∞—Ä
            available_products = [p for p in products if p.is_available()]
            if not available_products:
                current_game.status = 'finished'
                current_game.end_time = datetime.utcnow()
                return {
                    'success': False,
                    'message': '–í—Å–µ —Ç–æ–≤–∞—Ä—ã –ø—Ä–æ–¥–∞–Ω—ã!',
                    'game_over': True
                }
            
            selected_product = random.choice(available_products)
            current_game.current_product_id = selected_product.id
            
            # –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤–æ–≥–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
            winner = self._find_first_buyer(selected_product)
            
            if winner:
                # –ï—Å—Ç—å –ø–æ–∫—É–ø–∞—Ç–µ–ª—å!
                profit = winner.buy_product(selected_product, selected_product.current_price)
                selected_product.sell_one()
                
                # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä —Ä–∞—É–Ω–¥–∞
                current_game.current_round += 1
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ –∏–≥—Ä—ã
                game_over, message = self._check_game_over()
                if game_over:
                    current_game.status = 'finished'
                    current_game.end_time = datetime.utcnow()
                
                return {
                    'success': True,
                    'round': current_game.current_round - 1,
                    'current_lot': selected_product.to_dict(),
                    'winner': {
                        'id': winner.id,
                        'name': winner.name,
                        'purchase_price': selected_product.current_price,
                        'profit': profit
                    },
                    'message': f'{winner.name} –∫—É–ø–∏–ª {selected_product.name} –∑–∞ {selected_product.current_price:,} ‚ÇΩ',
                    'game_over': game_over,
                    'game_over_message': message
                }
            else:
                # –ù–∏–∫—Ç–æ –Ω–µ –∫—É–ø–∏–ª - —Å–Ω–∏–∂–∞–µ–º —Ü–µ–Ω—É
                selected_product.reduce_price(1 - self.price_reduction_step)
                
                return {
                    'success': True,
                    'round': current_game.current_round,
                    'current_lot': selected_product.to_dict(),
                    'winner': None,
                    'message': f'–¶–µ–Ω–∞ —Å–Ω–∏–∂–µ–Ω–∞ –¥–æ {selected_product.current_price:,} ‚ÇΩ. –ö—Ç–æ –≥–æ—Ç–æ–≤ –∫—É–ø–∏—Ç—å?',
                    'game_over': False
                }
                
        except Exception as e:
            return {
                'success': False,
                'message': f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ —Ä–∞—É–Ω–¥–∞: {str(e)}'
            }
    
    def _find_first_buyer(self, product):
        """–ù–∞—Ö–æ–¥–∏—Ç –ø–µ—Ä–≤–æ–≥–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è"""
        global players
        
        active_players = [p for p in players if p.balance > 0]
        players_with_preference = []
        
        for player in active_players:
            if player.can_buy(product.current_price):
                preference_multiplier = player.get_preference_multiplier(product.name)
                random_factor = random.uniform(0.1, 1.0)
                purchase_probability = preference_multiplier * random_factor
                players_with_preference.append((player, purchase_probability))
        
        if not players_with_preference:
            return None
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –ø–æ–∫—É–ø–∫–∏
        players_with_preference.sort(key=lambda x: x[1], reverse=True)
        
        # –í—ã–±–∏—Ä–∞–µ–º –∏–≥—Ä–æ–∫–∞
        if len(players_with_preference) > 1:
            top_players = players_with_preference[:min(3, len(players_with_preference))]
            if random.random() < 0.7:
                return top_players[0][0]
            else:
                return random.choice(top_players)[0]
        else:
            return players_with_preference[0][0]
    
    def _check_game_over(self):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã"""
        global products, players
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–≤–∞—Ä—ã
        available_products = [p for p in products if p.is_available()]
        if len(available_products) == 0:
            return True, "–í—Å–µ —Ç–æ–≤–∞—Ä—ã –ø—Ä–æ–¥–∞–Ω—ã!"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
        active_players = [p for p in players if p.balance > 0]
        
        if len(active_players) <= 1:
            if len(active_players) == 1:
                return True, f"–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –∏–≥—Ä—ã: {active_players[0].name}!"
            else:
                return True, "–£ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –¥–µ–Ω—å–≥–∏!"
        
        return False, ""
    
    def get_game_statistics(self):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–≥—Ä—ã"""
        global players, current_game
        
        try:
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –ø—Ä–∏–±—ã–ª–∏
            sorted_players = sorted(players, key=lambda p: p.total_profit, reverse=True)
            
            total_profit = sum(p.total_profit for p in players)
            total_purchases = sum(p.purchases for p in players)
            best_player = sorted_players[0] if sorted_players else None
            
            return {
                'players': [p.to_dict() for p in sorted_players],
                'total_profit': total_profit,
                'total_purchases': total_purchases,
                'best_player': best_player.name if best_player else '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
                'game_info': current_game.to_dict() if current_game else None
            }
        except Exception as e:
            return {
                'success': False,
                'message': f'–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {str(e)}'
            }
    
    def reset_game(self):
        """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏–≥—Ä—É"""
        global current_game, players, products
        
        try:
            if current_game:
                current_game.status = 'finished'
                current_game.end_time = datetime.utcnow()
            
            reset_all_players()
            reset_all_products()
            
            return True
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –∏–≥—Ä—ã: {e}")
            return False

# –°–æ–∑–¥–∞–µ–º –¥–≤–∏–∂–æ–∫ –∞—É–∫—Ü–∏–æ–Ω–∞
auction_engine = SimpleDutchAuctionEngine()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
create_initial_data()

# ============================================================================
# –ú–ê–†–®–†–£–¢–´
# ============================================================================

@app.route('/')
def index():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
    return render_template('index.html')

@app.route('/game')
def game():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–≥—Ä—ã"""
    return render_template('game.html')

@app.route('/statistics')
def statistics():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    return render_template('statistics.html')

# ============================================================================
# API ENDPOINTS
# ============================================================================

@app.route('/api/game/start', methods=['POST'])
def start_game():
    """–ù–∞—á–∏–Ω–∞–µ—Ç –Ω–æ–≤—É—é –∏–≥—Ä—É"""
    try:
        import uuid
        session_id = str(uuid.uuid4())
        session['user_session_id'] = session_id
        
        success = auction_engine.start_new_game(session_id)
        
        if success:
            user_player = get_user_player(session_id)
            return jsonify({
                'success': True,
                'message': '–ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ –Ω–∞—á–∞—Ç–∞!',
                'user_data': user_player.to_dict() if user_player else None
            })
        else:
            return jsonify({
                'success': False,
                'message': '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–≥—Ä—ã'
            }), 500
            
    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {str(e)}'
        }), 500

@app.route('/api/game/next-round', methods=['POST'])
def next_round():
    """–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥"""
    try:
        result = auction_engine.conduct_dutch_auction_round()
        return jsonify(result)
    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {str(e)}'
        }), 500

@app.route('/api/game/status')
def game_status():
    """–°—Ç–∞—Ç—É—Å –∏–≥—Ä—ã"""
    try:
        game_state = auction_engine.get_current_game_state()
        return jsonify(game_state)
    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {str(e)}'
        }), 500

@app.route('/api/game/statistics')
def game_statistics():
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã"""
    try:
        stats = auction_engine.get_game_statistics()
        return jsonify(stats)
    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {str(e)}'
        }), 500

@app.route('/api/game/reset', methods=['POST'])
def reset_game():
    """–°–±—Ä–æ—Å –∏–≥—Ä—ã"""
    try:
        success = auction_engine.reset_game()
        if success:
            return jsonify({
                'success': True,
                'message': '–ò–≥—Ä–∞ —Å–±—Ä–æ—à–µ–Ω–∞!'
            })
        else:
            return jsonify({
                'success': False,
                'message': '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –∏–≥—Ä—ã'
            }), 500
    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {str(e)}'
        }), 500

@app.route('/api/user/buy', methods=['POST'])
def buy_product():
    """–ü–æ–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"""
    try:
        data = request.get_json()
        product_id = data.get('product_id')
        session_id = session.get('user_session_id')
        
        if not product_id:
            return jsonify({
                'success': False,
                'message': 'ID —Ç–æ–≤–∞—Ä–∞ –Ω–µ —É–∫–∞–∑–∞–Ω'
            }), 400
        
        if not session_id:
            return jsonify({
                'success': False,
                'message': '–°–µ—Å—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
            }), 400
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–æ–≤–∞—Ä
        user_player = get_user_player(session_id)
        if not user_player:
            return jsonify({
                'success': False,
                'message': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-–∏–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω'
            }), 404
        
        product = next((p for p in products if p.id == product_id), None)
        if not product:
            return jsonify({
                'success': False,
                'message': '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'
            }), 404
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
        if not user_player.can_buy(product.current_price):
            return jsonify({
                'success': False,
                'message': '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏'
            }), 400
        
        # –ü–æ–∫—É–ø–∞–µ–º —Ç–æ–≤–∞—Ä
        profit = user_player.buy_product(product, product.current_price)
        product.sell_one()
        
        return jsonify({
            'success': True,
            'message': f'–¢–æ–≤–∞—Ä {product.name} –∫—É–ø–ª–µ–Ω –∑–∞ {product.current_price:,} ‚ÇΩ',
            'user_data': user_player.to_dict(),
            'profit': profit
        })
        
    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {str(e)}'
        }), 500

@app.route('/api/user/data')
def get_user_data():
    """–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    try:
        session_id = session.get('user_session_id')
        
        if not session_id:
            return jsonify({
                'success': False,
                'message': '–°–µ—Å—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
            })
        
        user_player = get_user_player(session_id)
        
        if not user_player:
            return jsonify({
                'success': False,
                'message': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-–∏–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω'
            })
        
        return jsonify({
            'success': True,
            'user_data': user_player.to_dict()
        })
        
    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {str(e)}'
        }), 500

# ============================================================================
# –ó–ê–ü–£–°–ö
# ============================================================================

if __name__ == '__main__':
    print("=" * 60)
    print("üå∏ –ì–û–õ–õ–ê–ù–î–°–ö–ò–ô –ê–£–ö–¶–ò–û–ù GOLAN - –ü–†–û–°–¢–ê–Ø –í–ï–†–°–ò–Ø üå∏")
    print("=" * 60)
    print()
    print("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...")
    print("üì± –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä: http://localhost:5000")
    print("‚èπÔ∏è  –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C")
    print()
    
    try:
        app.run(debug=True, host='0.0.0.0', port=5000)
    except KeyboardInterrupt:
        print("\nüëã –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!")
